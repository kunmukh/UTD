#!/bin/sh

TOKEN="S7bK3qzFDOn4dRHJax5NtQ"
TIMEOUT_TIME="60"

while true
do

  # run the script
  python3 download-similar-mal-hash-v2.py

  # copy the new new malwares to a folder
  date_today=$(date +%m-%d-%Y)

  # create the malwares zip
  mkdir -p "send-malware/similar-malware-dir_$date_today"
  find new-similar-malwares -mtime -1 -exec cp {} "send-malware/similar-malware-dir_$date_today" \;

  FILES="send-malware/similar-malware-dir_$date_today/*.bin"

  for file in $FILES
  do
    p3=$(echo $file | cut -d "/" -f 3)
    mv "send-malware/similar-malware-dir_$date_today/$p3" "send-malware/similar-malware-dir_$date_today/vt_kunal_4_$p3"
  done

  zip -r "send-malware/similar-malware-dir_$date_today.zip" "send-malware/similar-malware-dir_$date_today"

  # send email
  date_today1=$(date +%Y-%m-%d)
  mal_num=$(cat "malware-list/new_mal_$date_today1.txt" | wc -l)

  echo "Subject: Malware Dowloaded" > messages/mal-message_$date_today1.txt
  echo "Malware downloaded: $mal_num date: $date_today1" >> messages/mal-message_$date_today1.txt
  date >> messages/mal-message_$date_today1.txt
  sendmail kxm180046@utdallas.edu < messages/mal-message_$date_today1.txt

  # send to cuckoo
  mals="send-malware/similar-malware-dir_$date_today/*"

  for mal in $mals
  do
    echo $mal
    curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo01:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo02:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
  done

  i=0
  until [ $i -gt 78000 ]
  do
    sleep 1
    echo "program restarts in T-$((78000-$i)) seconds"
    i=$((i+5))
  done

done

