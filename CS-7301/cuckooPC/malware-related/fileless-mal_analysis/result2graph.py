# Name: Kunal Mukherjee
# Personal email: kunmukh@GMAIL.COM
# Date: 10/28/20
# File name: 
# Project name: splitbrain

from os import listdir
import os
import logging
import subprocess
import graphviz

results_path = 'results-fileless/'


def main():

    # get all the dir in results
    list_dir_result = listdir(results_path)
    list_dir_result = [dir for dir in list_dir_result if dir != ".DS_Store"]
    print(list_dir_result)

    # for every dir in results
    for dir in list_dir_result:
        print(dir)
        # create a 'callDir' dir and 'pdf' dir
        call_dir_path = results_path + dir + "/callDir/"
        try:
            if not os.path.exists(call_dir_path) and not os.path.isdir(call_dir_path):
                p0 = subprocess.run(["mkdir callDir"],
                                    cwd=results_path + dir,
                                    shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                    universal_newlines=True)
                p0 = subprocess.run(["mkdir pdf"],
                                    cwd=results_path + dir + "/callDir/",
                                    shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                    universal_newlines=True)
                print("callDir and pdf created", p0.stdout)
        except Exception as e:  # maybe too broad but we still need to know why it has failed.
            logging.warning("results directory empty:", str(e))

        # copy top 10 .call files to 'callDir'
        try:
            if os.listdir(call_dir_path):
                p0 = subprocess.run(["ls -Sh *.call | head -n 10 | awk '{print \"cp \" $1 \" callDir\"}' | sh"],
                                    cwd=results_path + dir,
                                    shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                    universal_newlines=True)
                print("largest 10 .call files moved", p0.stdout)
        except Exception as e:  # maybe too broad but we still need to know why it has failed.
            logging.warning("callDir directory empty:", str(e))

        # list the top 10 .call files
        list_dir_call = listdir(results_path + dir + "/callDir/")
        list_dir_call = [dir for dir in list_dir_call if dir != ".DS_Store"]
        
        # make a pdf of the .call files
        for call in list_dir_call:
            if call != "pdf":
                print(call)
                s = graphviz.Source.from_file(results_path + dir + "/callDir/" + call)
                s.render(call, results_path + dir + "/callDir/pdf/")

        # clean the pdf folder
        try:
            p0 = subprocess.run(["rm *.call"],
                                cwd=results_path + dir + "/callDir/pdf/",
                                shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                universal_newlines=True)
            print("pdf folder cleaned", p0.stdout)
        except Exception as e:  # maybe too broad but we still need to know why it has failed.
            logging.warning("pdf dir empty:", str(e))
            

if __name__ == '__main__':
    main()