#!/bin/sh

log_file="query-log.json"

TOKEN="S7bK3qzFDOn4dRHJax5NtQ"
TIMEOUT_TIME="60"

while true
do

  # CUCKOO1-------
  curl -s -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" http://syssec-cuckoo01:8090/cuckoo/status > $log_file

  mals_left=$( jq ".tasks.pending" $log_file)

  if [ "$mals_left" -lt 4000 ]
  then
    echo "SENDING MALWARES TO CUCKOO1"

    # send to cuckoo
    mals1="new-similar-fileless-malwares/*"

    for mal in $mals1
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo01:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done

    mals2="new-similar-malwares/*"

    for mal in $mals2
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo01:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done
    
    mals3="intel/*"

    for mal in $mals3
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo01:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done
    
    mals4="amd/*"

    for mal in $mals4
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo01:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done

  else
    echo "CUCKOO1 malware left cuckoo1: $mals_left"
  fi
  #----------------
  # CUCKOO2-------
  curl -s -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" http://syssec-cuckoo02:8090/cuckoo/status > $log_file

  mals_left=$( jq ".tasks.pending" $log_file)

  if [ "$mals_left" -lt 5000 ]
  then
    echo "SENDING MALWARES TO CUCKOO2"

    # send to cuckoo
    mals1="new-similar-fileless-malwares/*"

    for mal in $mals1
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo02:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done

    mals2="new-similar-malwares/*"

    for mal in $mals2
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo02:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done
    
     mals3="intel/*"

    for mal in $mals3
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo02:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done
    
    mals4="amd/*"

    for mal in $mals4
    do
      echo $mal
      curl -H 'Accept: application/json' -H "Authorization: Bearer ${TOKEN}" -F file=@$mal http://syssec-cuckoo02:8090/tasks/create/file -F "timeout=$TIMEOUT_TIME"
    done

  else
   echo "CUCKOO2 malware left cuckoo2: $mals_left"
  fi
  #----------------

  sleep 30
  date_today=$(date +%m-%d-%Y+%T)
  echo "-------------------------------"
  echo $date_today



done
